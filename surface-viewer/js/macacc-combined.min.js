function MNIObject(b){var a;this.parse=function(c){this.num_hemispheres=1;c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a=c.split(/\s+/).reverse();this.objectClass=a.pop();if(this.objectClass==="P"){this.parse_polygon_class()}else{throw new Error("This object class is not supported currently")}if(this.positionArray.length>80000*3){this.split_hemispheres()}};this.parse_polygon_class=function(){this.surfaceProperties={ambient:parseFloat(a.pop()),diffuse:parseFloat(a.pop()),specular_reflectance:parseFloat(a.pop()),specular_scattering:parseFloat(a.pop()),transparency:parseFloat(a.pop())};this.numberVertices=parseFloat(a.pop());this.positionArray=new Array();for(var d=0;d<this.numberVertices;d++){for(var e=0;e<3;e++){this.positionArray.push(parseFloat(a.pop()))}}this.normalArray=new Array();for(var k=0;k<this.numberVertices;k++){for(var e=0;e<3;e++){this.normalArray.push(parseFloat(a.pop()))}}this.numberPolygons=parseInt(a.pop());this.colorFlag=parseInt(a.pop());this.colorArray=new Array();if(this.colorFlag===0){for(var e=0;e<4;e++){this.colorArray.push(parseFloat(a.pop()))}}else{if(this.colorFlag===1){for(var j=0;j<this.numberPolygons;j++){for(var e=0;e<4;e++){this.colorArray.push(parseFloat(a.pop()))}}}else{if(this.colorFlag===2){for(var j=0;j<this.numberVertices;j++){for(var e=0;e<4;e++){this.colorArray.push(parseFloat(a.pop()))}}}else{throw new Error("colorFlag not valid in this file")}}}var g=new Array();for(var h=0;h<this.numberPolygons;h++){g.push(parseInt(a.pop()))}this.indexArray=new Array();var f=a.length;for(var e=0;e<f;e++){this.indexArray.push(parseInt(a.pop()))}};this.split_hemispheres=function(){this.left={};this.right={};var g=this.positionArray.length;this.left.positionArray=this.positionArray.slice(0,g/2);this.right.positionArray=this.positionArray.slice(g/2,g);var f=this.indexArray.length;this.left.indexArray=this.indexArray.slice(0,f/2);this.right.indexArray=this.indexArray.slice(f/2,f);for(var c=0;c<this.right.indexArray.length;c++){this.right.indexArray[c]=this.right.indexArray[c]-2-f/3/2/2}var d=this.normalArray.length;this.left.normalArray=this.normalArray.slice(0,d/2);this.right.normalArray=this.normalArray.slice(d/2,d);this.left.colorFlag=this.colorFlag;this.right.colorFlag=this.colorFlag;if(this.colorFlag==0||this.colorFlag==1){this.left.colorArray=this.colorArray;this.right.colorArray=this.colorArray}else{var e=this.colorArray.length;this.left.colorArray=this.colorArray.slice(0,e/2);this.right.colorArray=this.colorArray.slice(e/2+1,-1)}this.left.numberVertices=this.numberVertices/2;this.right.numberVertices=this.numberVertices/2;this.left.numberPolygons=this.numberPolygons/2;this.right.numberPolygons=this.numberPolygons/2;this.num_hemispheres=2};this.getVertexInfo=function(d){var c=[this.positionArray[d*3],this.positionArray[d*3+1],this.positionArray[d*3+2]];return{vertex:d,position_vector:c}};this.get_vertex=function(o,l,c){if(this.num_hemispheres>1){var j=this[c];var f=0;if(c=="right"){f=2+j.indexArray.length/3/2}}else{var j=this;var f=0}var h=new Array();var r=o*3;for(var g=0;g<3;g++){h.push(j.indexArray[r+g])}var p=new Array();for(var g=0;g<3;g++){var n=h[g]*3;p[g]=new Array();for(var e=0;e<3;e++){p[g][e]=j.positionArray[n+e]}}var q=new Array();for(var g=0;g<3;g++){q.push(o3djs.math.distance(l,p[g]))}var d=0;if(q[1]<q[0]){d=1}if(q[2]<q[d]){d=2}var m=h[d]+f;var s=p[d];return{vertex:m,position_vector:s}};if(b){this.parse(b)}}function Spectrum(d){var b=this;function a(e,f,k,m){var g=document.createElement("canvas");jQuery(g).attr("width",e.length);jQuery(g).attr("height",k);var j=g.getContext("2d");if(m){for(var h=0;h<e.length;h++){var l=e.length-1-h;j.fillStyle="rgb("+parseInt(parseFloat(e[l][0])*255)+","+parseInt(parseFloat(e[l][1])*255)+","+parseInt(parseFloat(e[l][2])*255)+")";j.fillRect(h,0,1,f)}}else{for(var h=0;h<e.length;h++){j.fillStyle="rgb("+parseInt(parseFloat(e[h][0])*255)+","+parseInt(parseFloat(e[h][1])*255)+","+parseInt(parseFloat(e[h][2])*255)+")";j.fillRect(h,0,1,f)}}return g}b.createSpectrumCanvas=function(e){if(e==null){e=b.colors}var f=a(e,20,20,false);return f};b.createSpectrumCanvasWithScale=function(i,e,f,j){if(f==null){f=b.colors}var g=a(f,20,40,j);var h=g.getContext("2d");h.fillStyle="rgba(0,0,0,1)";h.fillRect(0.5,20,1,10);h.fillText(i.toPrecision(3),0.5,40);h.fillRect(g.width/4,20,1,10);h.fillText(((i+e)/4).toPrecision(3),g.width/4,40);h.fillRect(g.width/2,20,1,10);h.fillText(((i+e)/2).toPrecision(3),g.width/2,40);h.fillRect(3*(g.width/4),20,1,10);h.fillText((3*((i+e)/4)).toPrecision(3),3*(g.width/4),40);h.fillRect(g.width-0.5,20,1,10);h.fillText(e.toPrecision(3),g.width-20,40);return g};function c(l){l=l.replace(/\s+$/,"");l=l.replace(/^\s+/,"");var h=l.split(/\n/);var e=new Array();for(var g=0;g<h.length;g++){var j=h[g].split(/\s+/);for(var f=0;f<3;f++){j[f]=parseFloat(j[f])}j.push(1);e.push(j)}b.colors=e;return e}if(d){c(d)}}function MNIData(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};a.createColorArray=function(g,d,e){var e=e.colors;var h=[];var c=((d-g)+(d-g)/e.length)/e.length;for(var f=0;f<a.values.length;f++){if(a.values[f]<=g){var j=0}else{if(a.values[f]>d){var j=e.length-1}else{var j=parseInt((a.values[f]-g)/c)}}h.push.apply(h,e[j])}return h};if(b){a.parse(b)}}function Dataset(){this.path=function(e,d){var b="ICBM152_"+d.sk;if(d.modality=="CT"){var a="ICBM152_"+d.modality+"_MACACC_mean"}else{var a="ICBM152_"+d.modality+"_MACACC_size"}if(d.statistic=="T"){var c="T_map/T_"}else{if(d.statistic=="P1"){var c="RTF_C_map/RTF_C_"}else{if(d.statistic=="P2"){var c="RTF_V_map/RTF_V_"}}}return"/data/"+a+"/"+b+"/"+c+e+".txt"};this.parse=function(b){var a=b;a=a.replace(/\s+$/,"");a=a.replace(/^\s+/,"");this.data=a.split(/\s+/);this.min=this.data.min();this.max=this.data.max()};this.get_data=function(c,a,e){if(c=="aal_atlas"){var d="/assets/aal_atlas.txt"}else{var d=this.path(c,a)}var b=this;jQuery.ajax({type:"GET",url:d,dataType:"text",success:function(f){b.parse(f);e(b)},error:function(){jQuery(g_pickInfoElem).html("Error loading map")}})}}o3djs.base.o3d=o3d;o3djs.require("o3djs.webgl");o3djs.require("o3djs.math");o3djs.require("o3djs.rendergraph");o3djs.require("o3djs.pack");o3djs.require("o3djs.picking");o3djs.require("o3djs.arcball");o3djs.require("o3djs.quaternions");o3djs.require("o3djs.scene");Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function BrainBrowser(c){var d=this;this.setup=function(e){d.preload_model(e)};this.init=function(){o3djs.webgl.makeClients(d.initStep2)};d.initStep2=function(f){var g=f[0];d.o3dElement=g;d.client=g.client;d.o3d=g.o3d;d.math=o3djs.math;d.dragging=false;d.o3dWidth=-1;d.o3dHeight=-1;d.quaternions=o3djs.quaternions;d.lastRot=d.math.matrix4.identity();d.thatRot=d.math.matrix4.identity();d.zoomFactor=1.1;d.keyPressDelta=0.1;d.clock=0;d.timeMult=1;d.camera={farPlane:5000,nearPlane:0.1};d.loading=jQuery("#o3d_loading");o3djs.base.init(g);d.pack=d.client.createPack();var e=o3djs.rendergraph.createBasicView(d.pack,d.client.root,d.client.renderGraphRoot,[0.5,0.5,0.5,1]);d.viewInfo=e;e.drawContext.projection=d.math.matrix4.perspective(d.math.degToRad(30),d.client.width/d.client.height,1,5000);d.eyeView=[0,0,500];e.drawContext.view=d.math.matrix4.lookAt(d.eyeView,[0,0,0],[0,1,0]);d.aball=o3djs.arcball.create(100,100);d.client.setRenderCallback(d.renderCallback);jQuery("body").keydown(d.keyPressedCallback);o3djs.event.addEventListener(g,"wheel",d.scrollMe);d.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");if(d.afterInit){d.afterInit(d)}d.updateInfo();jQuery("#screenshot").click(function(h){jQuery(this).attr("href",bb.client.toDataURL())})};this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(e){d.setClientSize()};this.createBrain=function(m){d.model_data=m;var p=d.pack.createObject("Effect");var g;jQuery.ajax({type:"GET",url:"/shaders/blinnphong.txt",dataType:"text",success:function(r){g=r},error:function(r,t,s){alert("Failure: "+t)},data:{},async:false,timeout:10000});p.loadFromFXString(g);var j=d.pack.createObject("Material");j.drawList=d.viewInfo.performanceDrawList;j.effect=p;p.createUniformParameters(j);if(m.num_hemispheres==2){var f={left:d.createHemisphere(j,m.left,"left"),right:d.createHemisphere(j,m.right,"right"),num_hemisphere:2}}else{var f=d.createHemisphere(j,m);f.num_hemisphere=1}if(d.brainTransform==null){d.brainTransform=d.pack.createObject("Transform");if(m.num_hemispheres==2){d.brainHemisphereTransforms={};d.brainHemisphereTransforms.left=d.pack.createObject("Transform");d.brainHemisphereTransforms.right=d.pack.createObject("Transform")}}else{d.brainTransform.removeShape(d.brainTransform.shapes[0]);if(d.brainTransform.children[0]!=null){d.brainTransform.children[0].removeShape(d.brainTransform.children[0].shapes[0])}if(d.brainTransform.children[1]!=null){d.brainTransform.children[1].removeShape(d.brainTransform.children[1].shapes[0])}}if(m.num_hemispheres!=2){d.brainTransform.removeParam(d.brainTransform.children[0]);d.brainTransform.removeParam(d.brainTransform.children[1])}if(m.num_hemispheres==2&&d.brainHemisphereTransforms==null){d.brainHemisphereTransforms={};d.brainHemisphereTransforms.left=d.pack.createObject("Transform");d.brainHemisphereTransforms.right=d.pack.createObject("Transform")}var q=j.getParam("lightWorldPos");q.value=d.eyeView;var e=j.getParam("ambient");var l=j.getParam("ambientIntensity");var k=j.getParam("lightIntensity");var o=j.getParam("specular");var n=j.getParam("emissive");var h=j.getParam("colorMult");e.value=[0.04,0.04,0.04,1];l.value=[1,1,1,1];k.value=[0.8,0.8,0.8,1];o.value=[0.5,0.5,0.5,1];n.value=[0,0,0,1];h.value=[1,1,1,1];var i=j.getParam("shininess");i.value=30;d.brainTransform.parent=d.client.root;if(f.num_hemisphere==1){d.brainTransform.addShape(f);f.createDrawElements(d.pack,null)}else{d.brainHemisphereTransforms.left.parent=d.brainTransform;d.brainHemisphereTransforms.right.parent=d.brainTransform;d.brainHemisphereTransforms.left.addShape(f.left);d.brainHemisphereTransforms.right.addShape(f.right);f.left.createDrawElements(d.pack,null);f.right.createDrawElements(d.pack,null)}d.model_data=m;if(d.afterCreateBrain!=undefined){d.afterCreateBrain(d.model_data)}};d.createHemisphere=function(l,k,g){var t=d.pack.createObject("Shape");var q=d.pack.createObject("Primitive");var v=d.pack.createObject("StreamBank");q.material=l;q.owner=t;q.streamBank=v;t.name=g;q.primitiveType=d.o3d.Primitive.TRIANGLE_LIST;var f=d.pack.createObject("State");var n=d.pack.createObject("VertexBuffer");var p=n.createField("FloatField",3);if(!k.positionArray){alert("PositionArray nil");return false}n.set(k.positionArray);d.numberVertices=k.numberVertices;var u=(k.positionArray.length/3);q.numberVertices=d.numberVertices;if(!k.indexArray){alert("Index Array nil");return false}q.numberPrimitives=k.indexArray.length/3;var j=d.pack.createObject("IndexBuffer");j.set(k.indexArray);q.indexBuffer=j;var s=d.pack.createObject("VertexBuffer");var m=s.createField("FloatField",3);s.set(k.normalArray);var o=[];if(k.colorArray.length==4){for(var h=0;h<u;h++){o.push.apply(o,[0.5,0.5,0.7,1])}}if(o.length<k.positionArray.length){alert("Problem with the colors: "+o.length)}var r=d.pack.createObject("VertexBuffer");var e=r.createField("FloatField",4);r.set(o);o=[];if(d.loading){jQuery(d.loading).html("Buffers Loaded")}v.setVertexStream(d.o3d.Stream.POSITION,0,p,0);v.setVertexStream(d.o3d.Stream.NORMAL,0,m,0);v.setVertexStream(d.o3d.Stream.COLOR,0,e,0);return t};d.resetView=function(){d.brainTransform.children[0].visible=true;d.brainTransform.children[1].visible=true;d.brainTransform.identity();d.brainTransform.children[0].identity();d.brainTransform.children[1].identity()};this.setupView=function(f){d.resetView();if(d.model_data&&d.model_data.num_hemispheres==2){var g=d.getViewParams();switch(g.view){case"superior":d.superiorView();break;case"medial":d.medialView();break;case"anterior":d.anteriorView();break;case"inferior":d.inferiorView();break;case"lateral":d.lateralView();break;case"posterior":d.posteriorView();break;default:d.superiorView();break}}if(g.left==true){d.leftHemisphereVisible(true)}else{d.leftHemisphereVisible(false)}if(g.right==true){d.rightHemisphereVisible(true)}else{d.rightHemisphereVisible(false)}d.thatRot=d.math.matrix4.mul(d.brainTransform.localMatrix,d.math.matrix4.identity())};this.leftHemisphereVisible=function(e){d.brainTransform.children[0].visible=e};this.rightHemisphereVisible=function(e){d.brainTransform.children[1].visible=e};this.medialView=function(f){if(d.model_data.num_hemispheres==2){d.brainTransform.children[0].translate([-100,0,0]);d.brainTransform.children[1].translate([100,0,0]);d.brainTransform.children[0].rotateZ(d.math.degToRad(-90));d.brainTransform.children[1].rotateZ(d.math.degToRad(90));d.brainTransform.rotateX(d.math.degToRad(-90))}};this.lateralView=function(f){if(d.model_data.num_hemispheres==2){d.brainTransform.children[0].translate([-100,0,0]);d.brainTransform.children[1].translate([100,0,0]);d.brainTransform.children[0].rotateZ(d.math.degToRad(-90));d.brainTransform.children[1].rotateZ(d.math.degToRad(90));d.brainTransform.rotateX(d.math.degToRad(90));d.brainTransform.rotateY(d.math.degToRad(180))}};this.superiorView=function(){};this.inferiorView=function(){d.brainTransform.rotateY(d.math.degToRad(180))};this.anteriorView=function(f){d.resetView();d.brainTransform.rotateX(d.math.degToRad(-90));d.brainTransform.rotateZ(d.math.degToRad(180))};this.posteriorView=function(f){d.resetView();d.brainTransform.rotateX(d.math.degToRad(-90))};this.separateHemispheres=function(f){if(d.model_data.num_hemispheres==2){this.brainTransform.children[0].translate([-1,0,0]);this.brainTransform.children[1].translate([1,0,0])}};this.setClientSize=function(){var f=parseInt(d.client.width);var e=parseInt(d.client.height);if(f!=d.o3dWidth||e!=d.o3dHeight){d.o3dWidth=f;d.o3dHeight=e;d.updateProjection();d.aball.setAreaSize(d.o3dWidth,d.o3dHeight)}};d.ZoomInOut=function(f){for(var e=0;e<d.eyeView.length;e+=1){d.eyeView[e]=d.eyeView[e]/f}d.viewInfo.drawContext.view=d.math.matrix4.lookAt(d.eyeView,[0,0,0],[0,1,0])};d.scrollMe=function(g){var f=(g.deltaY<0)?1/d.zoomFactor:d.zoomFactor;d.ZoomInOut(f);d.client.render()};function a(e){b();if(e){d.selectedInfo=e}}this.updateInfo=function(){if(!d.treeInfo){d.treeInfo=o3djs.picking.createPickManager(d.client.root)}d.treeInfo.update()};function b(){if(d.selectedInfo){d.highlightShape=null;d.selectedInfo=null}}this.click=function(l,i){var h=o3djs.picking.clientPositionToWorldRay(l.x,l.y,d.viewInfo.drawContext,d.client.width,d.client.height);b();d.treeInfo.update();var j=d.treeInfo.pick(h);if(j){a(j);var n=j.rayIntersectionInfo.primitiveIndex;var k=j.rayIntersectionInfo.position;var f=j.element.owner.name;var m=d.model_data.get_vertex(n,k,f);var g={primitive_index:n,position_vector:m.position_vector,element:j.element,hemisphere:f,vertex:m.vertex};return i(l,g)}else{jQuery(d.pickInfoElem).html("--nothing--")}return false};d.getInfoForVertex=function(e){return d.model_data.getVertexInfo(e)};d.startDragging=function(f){if(f.shiftKey&&f.ctrlKey&&d.model_data.num_hemispheres==2){d.drag_hemisphere=click(f,function(e,g){if(g.hemisphere=="left"){return 0}else{if(g.hemisphere=="right"){return 1}else{return false}}})}d.lastRot=d.thatRot;d.aball.click([f.x,f.y]);d.dragging=true};d.drag=function(i){if(d.dragging&&i.button==d.o3d.Event.BUTTON_LEFT){var h=d.aball.drag([i.x,i.y]);var g=d.quaternions.quaternionToRotation(h);d.thatRot=d.math.matrix4.mul(d.lastRot,g);if(d.drag_hemisphere===0||d.drag_hemisphere===1){var f=d.brainTransform.children[d.drag_hemisphere].localMatrix;d.math.matrix4.setUpper3x3(f,d.thatRot);d.brainTransform.children[d.drag_hemisphere].localMatrix=f}else{var f=d.brainTransform.localMatrix;d.math.matrix4.setUpper3x3(f,d.thatRot);d.brainTransform.localMatrix=f}}else{if(d.dragging){d.stopDragging(i)}}};d.stopDragging=function(f){d.drag_hemisphere=false;d.dragging=false};d.updateCamera=function(){var e=[0,1,0];d.viewInfo.drawContext.view=d.math.matrix4.lookAt(d.camera.eye,d.camera.target,e);d.lightPosParam.value=d.camera.eye};d.updateProjection=function(){d.viewInfo.drawContext.projection=d.math.matrix4.perspective(d.math.degToRad(45),d.o3dWidth/d.o3dHeight,d.camera.nearPlane,d.camera.farPlane)};d.keyPressedAction=function(e,g){var f=false;switch(e){case"&":d.ZoomInOut(d.zoomFactor);f="zoom_in";break;case"(":d.ZoomInOut(1/d.zoomFactor);f="zoom_out";break;case" ":d.separateHemispheres();f="separate";break}return f};d.keyPressedCallback=function(f){var e=false;switch(f.which){case 38:d.ZoomInOut(d.zoomFactor);e="ZoomIn";break;case 40:d.ZoomInOut(1/d.zoomFactor);e="ZoomOut";break;case 32:d.separateHemispheres();e="Seperate";break}if(e){return false}else{return true}};d.set_fill_mode_wireframe=function(){if(d.model_data.num_hemispheres==2){var e=d.brainTransform.children[0].shapes[0].elements[0].material;d.state=d.pack.createObject("State");e.state=d.state;d.state.getStateParam("FillMode").value=d.o3d.State.WIREFRAME;e=d.brainTransform.children[1].shapes[0].elements[0].material;e.state=d.state}else{var e=d.brainTransform.shapes[0].elements[0].material;d.state=d.pack.createObject("State");e.state=d.state;d.state.getStateParam("FillMode").value=d.o3d.State.WIREFRAME}d.client.render()};d.set_fill_mode_solid=function(){if(d.model_data.num_hemispheres==2){var e=d.brainTransform.children[0].shapes[0].elements[0].material;d.state1=d.pack.createObject("State");e.state=d.state1;d.state.getStateParam("FillMode").value=d.o3d.State.SOLID;e=d.brainTransform.children[1].shapes[0].elements[0].material;e.state=d.state}else{var e=d.brainTransform.shapes[0].elements[0].material;d.state=d.pack.createObject("State");e.state=d.state;d.state.getStateParam("FillMode").value=d.o3d.State.SOLID}};d.loadObjFromUrl=function(e){jQuery.ajax({type:"GET",url:e,dataType:"text",success:function(f){d.createBrain(new MNIObject(f))},error:function(f,h,g){alert("Failure: "+h)},data:{},async:true,timeout:100000})};d.loadObjFromFile=function(g){var e=new FileReader();var f=g.files;e.file=f[0];e.onloadend=function(h){d.createBrain(new MNIObject(h.target.result))};e.readAsText(f[0])};d.loadSpectrumFromUrl=function(e){jQuery.ajax({type:"GET",url:e,dataType:"text",success:function(g){var f=new Spectrum(g);d.spectrum=f;if(d.afterLoadSpectrum!=null){d.afterLoadSpectrum(f)}if(d.data){d.updateColors(d.data,d.rangeMin,d.rangeMax,d.spectrum)}}})};d.loadSpectrumFromFile=function(g){var e=new FileReader();var f=g.files;e.file=f[0];e.onloadend=function(h){d.spectrum=new Spectrum(h.target.result);if(d.data){d.updateColors(d.data,d.rangeMin,d.rangeMax,d.spectrum)}if(d.afterLoadSpectrum!=null){d.afterLoadSpectrum(d.spectrum)}};e.readAsText(f[0])};d.loadDataFromFile=function(g){var e=new FileReader();var f=g.files;e.file=f[0];e.onloadend=function(h){d.data=new MNIData(h.target.result);if(d.fixRange==false||d.fixRange==null){d.rangeMin=d.data.min;d.rangeMax=d.data.max;if(d.afterLoadData!=null){d.afterLoadData(d.rangeMin,d.rangeMax,d.data)}}d.updateColors(d.data,d.rangeMin,d.rangeMax,d.spectrum)};e.readAsText(f[0])};d.updateColors=function(w,o,q,u){if(d.data==null){return 0}var v=w.createColorArray(o,q,u);if(d.model_data.num_hemispheres==1){var l=d.pack.createObject("VertexBuffer");var p=l.createField("FloatField",4);l.set(v);var g=d.brainTransform.shapes[0];var j=g.elements[0].streamBank;j.setVertexStream(d.o3d.Stream.COLOR,0,p,0)}else{var f=v.slice(0,v.length/2);var n=v.slice(v.length/2,v.length);var k=d.pack.createObject("VertexBuffer");var s=k.createField("FloatField",4);k.set(f);var i=d.brainTransform.children[0].shapes[0];var m=i.elements[0].streamBank;m.setVertexStream(d.o3d.Stream.COLOR,0,s,0);var r=d.pack.createObject("VertexBuffer");var h=r.createField("FloatField",4);r.set(n);var t=d.brainTransform.children[1].shapes[0];var e=t.elements[0].streamBank;e.setVertexStream(d.o3d.Stream.COLOR,0,h,0);d.client.render()}if(d.afterUpdateColors!=null){d.afterUpdateColors(w,o,q,u)}return 1};d.rangeChange=function(f,e){d.rangeMin=f;d.rangeMax=e;d.updateColors(d.data,d.rangeMin,d.rangeMax,d.spectrum);if(d.afterRangeChange!=null){d.afterRangeChange(f,e)}};d.init()}var g_spectrum;function MacaccObject(j,n){var e=this;this.brainbrowser=j;this.dataSet=new Dataset(n);e.debugLineGroup;e.debugLine;e.selectedInfo=null;e.treeInfo;e.pickInfoElem;e.flashTimer=0;e.highlightMaterial;e.highlightShape;e.vertex;e.positionVector;e.primitiveIndex;e.dataArray;e.data_max;e.data_min;e.range_max;e.range_min;e.spectrum;e.coordinates=jQuery("#coordinates");e.selectPoint=null;function i(p,o){jQuery("#x-coord").val(p.position_vector[0]);jQuery("#y-coord").val(p.position_vector[1]);jQuery("#z-coord").val(p.position_vector[2]);jQuery("#v-coord").val(p.vertex);jQuery("#value-coord").val(o)}this.pickClick=function(p,o){e.vertex=o.vertex;if(e.vertex){a();i(o,0)}else{jQuery(e.pickInfoElem).html("--nothing--")}};this.change_model=function(p){var o=jQuery(p.target).val();j.loadObjFromUrl("/data/surfaces/surf_reg_model_both_"+o+".obj")};this.flipXCoordinate=function(){if(e.vertex>e.dataArray.length/2){e.vertex-=e.dataArray.length/2}else{e.vertex+=e.dataArray.length/2}i(j.getInfoForVertex(e.vertex),0);a()};this.valueAtPoint=function(q,p){var o=e.dataArray[p.vertex];if(p.vertex&&o){jQuery("#x-coord").val(p.position_vector[0]);jQuery("#y-coord").val(p.position_vector[1]);jQuery("#z-coord").val(p.position_vector[2]);jQuery("#v-coord").val(p.vertex);jQuery("#value-coord").val(o)}};function d(q,s,p,v){var t=new Array();var o=((p-s)+(p-s)/e.spectrum.length)/e.spectrum.length;for(var r=0;r<q.length;r++){if(q[r]<=s){var u=0}else{if(q[r]>p){var u=e.spectrum.length-1}else{var u=parseInt((q[r]-s)/o)}}if(v){t.push.apply(t,e.spectrum[e.spectrum.length-1-u])}else{t.push.apply(t,e.spectrum[u])}}k(s,p);return t}function c(p){if(j.model_data.num_hemispheres==1){var s=j.pack.createObject("VertexBuffer");var r=s.createField("FloatField",4);s.set(p);var A=j.brainTransform.shapes[0];var q=A.elements[0].streamBank;q.setVertexStream(j.o3d.Stream.COLOR,0,r,0)}else{var w=p.slice(0,p.length/2);var u=p.slice(p.length/2,p.length);var z=j.pack.createObject("VertexBuffer");var B=z.createField("FloatField",4);z.set(w);var o=j.brainTransform.children[0].shapes[0];var y=o.elements[0].streamBank;y.setVertexStream(j.o3d.Stream.COLOR,0,B,0);var t=j.pack.createObject("VertexBuffer");var x=t.createField("FloatField",4);t.set(u);var C=j.brainTransform.children[1].shapes[0];var v=C.elements[0].streamBank;v.setVertexStream(j.o3d.Stream.COLOR,0,x,0);j.client.render()}}function m(){var q=jQuery("[name=modality]:checked").val();var p=jQuery("#data-sk").val();var o=jQuery("[name=statistic]:checked").val();return{modality:q,sk:p,statistic:o}}function b(q,o,r){var p=d(e.dataArray,q,o,r);if(p!=-1){c(p)}}function l(p){e.dataArray=p.data;j.current_dataset=p;if(jQuery("#fix_range").attr("checked")==true){if(!(e.data_min=parseFloat(jQuery("#data-range-min").val()))){if(!e.data_min===0){e.data_min=p.min}}if(!(e.data_max=parseFloat(jQuery("#data-range-max").val()))){if(!e.data_max===0){e.data_max=p.max}}}else{if(m().statistic=="T"){e.data_min=p.min;e.data_max=p.max}}var o=jQuery("#flip_range").attr("checked");if(m().statistic=="T"){e.flipRange=o;jQuery("#range-slider").slider("option","min",p.min);jQuery("#range-slider").slider("option","max",p.max);b(e.data_min,e.data_max,o)}else{e.flipRange=!o;jQuery("#range-slider").slider("option","min","0");jQuery("#range-slider").slider("option","max","1");b(0,1,!o)}}e.update_model=l;function a(){e.dataSet.get_data(e.vertex,m(),l);jQuery(e.pickInfoElem).html("Viewing data for vertex: "+e.vertex)}this.show_atlas=function(){e.dataSet.get_data("aal_atlas",m(),l);jQuery(e.pickInfoElem).html("Viewing data for vertex: "+e.vertex)};function k(p,o){if(!jQuery("#fix_range").attr("checked")){jQuery("#data-range-min").val(p);jQuery("#data-range-max").val(o);jQuery("#range-slider").slider("values",0,p);jQuery("#range-slider").slider("values",1,o);if(e.afterRangeChange!=undefined){e.afterRangeChange(p,o)}}}function h(p,o){}this.range_change=function(){var p=parseFloat(jQuery("#data-range-min").val());var o=parseFloat(jQuery("#data-range-max").val());b(p,o);if(e.afterRangeChange!=undefined){e.afterRangeChange(p,o)}};this.data_control_change=function(){if(e.vertex){a()}};function g(t){t=t.replace(/\s+$/,"");t=t.replace(/^\s+/,"");var r=t.split(/\n/);var o=new Array();for(var q=0;q<r.length;q++){var s=r[q].split(/\s+/);for(var p=0;p<3;p++){s[p]=parseFloat(s[p])}s.push(1);o.push(s)}return o}function f(o){jQuery.ajax({type:"GET",url:"/assets/spectral_spectrum.txt",dataType:"text",success:function(q){var p=g(q);e.spectrum=p},data:{spectrum:o}})}f("spectral");j.updateInfo();j.valueAtPointCallback=this.valueAtPoint;j.clickCallback=this.pickClick}var brainbrowser;jQuery(function(){brainbrowser=new BrainBrowser();brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").attr("checked"),right:jQuery("#right_hem_visible").attr("checked")}};brainbrowser.afterLoadSpectrum=function(a){var b=a.createSpectrumCanvasWithScale(0,100,null,false);jQuery("#spectrum").html(jQuery(b));brainbrowser.spectrumObj=a};brainbrowser.afterInit=function(b){b.loadObjFromUrl("/models/surf_reg_model_both.obj");var a=new MacaccObject(b,"/data/gaolang_data/");brainbrowser.afterCreateBrain=function(){if(b.current_dataset!=undefined){a.update_model(b.current_dataset)}};a.afterRangeChange=function(e,c){if(a.flipRange==true){var d=b.spectrumObj.createSpectrumCanvasWithScale(e,c,null,true)}else{var d=b.spectrumObj.createSpectrumCanvasWithScale(e,c,null,false)}jQuery("#spectrum").html(jQuery(d))};jQuery("#fillmode").toggle(b.set_fill_mode_wireframe,b.set_fill_mode_solid);jQuery("#range-slider").slider({range:true,min:-100,max:200,value:[-10,10],slide:function(c,d){jQuery("#data-range-min").val(d.values[0]);jQuery("#data-range-max").val(d.values[1]);a.range_change()},step:0.1});jQuery(".range-box").keypress(function(c){if(c.keyCode=="13"){a.range_change(c)}});jQuery("#data-range-min").change(function(c){jQuery("#range-slider").slider("values",0,jQuery(this).val())});jQuery("#data-range-max").change(function(c){jQuery("#range-slider").slider("values",1,jQuery(this).val())});jQuery(".data_controls").change(a.data_control_change);a.pickInfoElem=jQuery("#vertex_info");jQuery("#x-coord-flip").click(a.flipXCoordinate);jQuery("[name=pointer]").change(function(c){if(jQuery("[name=pointer]:checked").val()=="AAL_atlas"){a.show_atlas()}});jQuery("#model").change(a.change_model);jQuery("#screenshot").click(function(c){jQuery(this).attr("href",b.client.toDataUR())});o3djs.event.addEventListener(b.o3dElement,"mousedown",function(c){var d=jQuery("[name=pointer]:checked").val();if(d=="rotate"&&!c.shiftKey&&!c.ctrlKey){b.startDragging(c)}else{if(c.shiftKey||d=="select"){if(b.clickCallback){b.click(c,b.clickCallback)}}else{if(c.ctrlKey||d=="check"){if(b.valueAtPointCallback){b.click(c,b.valueAtPointCallback)}}}}});o3djs.event.addEventListener(b.o3dElement,"mousemove",function(c){b.drag(c)});o3djs.event.addEventListener(b.o3dElement,"mouseup",function(c){if(!c.shiftKey||c.button==b.o3d.Event.BUTTON_RIGHT){b.stopDragging(c)}});jQuery("#flip_range").change(function(c){if(jQuery(c.target).attr("checked")==true){a.update_model(brainbrowser.current_dataset)}else{a.update_model(brainbrowser.current_dataset)}})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);jQuery(".button").button();jQuery(".button_set").buttonset()});